<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="checkoutPageTitle">Checkout - Nexus Wear</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&amp;family=Bebas+Neue&amp;display=swap" rel="stylesheet">
  <style>
    /* CSS ยังคงเดิมเพื่อรักษาดีไซน์ของคุณ */
    body { box-sizing: border-box; }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; overflow-x: hidden; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: #F5F5F5; color: #000000; line-height: 1.6; -webkit-font-smoothing: antialiased; }
    .page-wrapper { width: 100%; min-height: 100%; }
    .top-nav { background: #FFFFFF; border-bottom: 2px solid #000000; padding: 20px 0; }
    .nav-content { max-width: 1200px; margin: 0 auto; padding: 0 40px; display: flex; justify-content: space-between; align-items: center; }
    .logo-text { font-family: 'Bebas Neue', cursive; font-size: 24px; text-decoration: none; color: #000000; letter-spacing: 2px; }
    .checkout-container { max-width: 1200px; margin: 60px auto; padding: 0 40px; display: grid; grid-template-columns: 1fr 450px; gap: 60px; }
    .checkout-form-section { background: #FFFFFF; padding: 48px; border: 3px solid #000000; }
    .section-title { font-family: 'Bebas Neue', cursive; font-size: 32px; margin-bottom: 32px; border-bottom: 2px solid #000; padding-bottom: 10px; }
    .form-group { margin-bottom: 24px; }
    .form-label { display: block; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
    .form-input { width: 100%; padding: 16px; border: 2px solid #000; font-family: inherit; font-size: 14px; outline: none; transition: background 0.3s; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .summary-sticky { position: sticky; top: 40px; }
    .order-summary-card { background: #000; color: #FFF; padding: 40px; }
    .summary-title { font-family: 'Bebas Neue', cursive; font-size: 28px; margin-bottom: 24px; color: #FFF; }
    .summary-item { display: flex; justify-content: space-between; margin-bottom: 16px; font-size: 14px; opacity: 0.9; }
    .summary-total { border-top: 1px solid #333; margin-top: 24px; padding-top: 24px; display: flex; justify-content: space-between; font-size: 24px; font-weight: 900; }
    .place-order-btn { 
        width: 100%; padding: 24px; background: #FFF; color: #000; border: none; 
        font-weight: 800; font-size: 16px; text-transform: uppercase; margin-top: 32px; cursor: pointer;
        clip-path: polygon(5% 0%, 95% 0%, 100% 50%, 95% 100%, 5% 100%, 0% 50%);
        transition: transform 0.3s;
    }
    .place-order-btn:hover { transform: scale(1.03); }
    .place-order-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal-content { background: #FFF; padding: 60px; border: 4px solid #000; text-align: center; max-width: 500px; }

    @media (max-width: 968px) {
        .checkout-container { grid-template-columns: 1fr; }
        .summary-sticky { position: static; }
    }
  </style>
 </head>
 <body>
  <div class="page-wrapper">
   <header class="top-nav">
    <div class="nav-content">
     <a href="index.html" class="logo-text" id="brandLogo">NEXUS WEAR</a>
     <a href="cart.html" style="font-size:12px; font-weight:700; color:#000; text-decoration:none;">RETURN TO CART</a>
    </div>
   </header>

   <main class="checkout-container">
    <section class="checkout-form-section">
     <form id="checkoutForm">
      <div class="section-title">CONTACT INFORMATION</div>
      <div class="form-group">
       <label class="form-label">Email Address</label>
       <input type="email" id="email" class="form-input" placeholder="email@example.com" required>
      </div>

      <div class="section-title" style="margin-top:60px;">SHIPPING DETAILS</div>
      <div class="form-row">
       <div class="form-group">
        <label class="form-label">First Name</label>
        <input type="text" id="firstName" class="form-input" required>
       </div>
       <div class="form-group">
        <label class="form-label">Last Name</label>
        <input type="text" id="lastName" class="form-input" required>
       </div>
      </div>
      <div class="form-group">
       <label class="form-label">Phone Number</label>
       <input type="tel" id="phone" class="form-input" placeholder="08x-xxx-xxxx" required>
      </div>
      <div class="form-group">
       <label class="form-label">Shipping Address</label>
       <textarea id="address" class="form-input" style="height:100px; resize:none;" required></textarea>
      </div>
      <div class="form-row">
       <div class="form-group">
        <label class="form-label">Province</label>
        <input type="text" id="province" class="form-input" required>
       </div>
       <div class="form-group">
        <label class="form-label">ZIP Code</label>
        <input type="text" id="zip" class="form-input" required>
       </div>
      </div>
     </form>
    </section>

    <aside class="summary-sticky">
     <div class="order-summary-card">
      <h3 class="summary-title">YOUR ORDER</h3>
      <div id="summaryItemsList"></div>
      
      <div class="summary-total">
       <span>TOTAL</span>
       <span id="finalTotal">฿0</span>
      </div>
      
      <button type="submit" form="checkoutForm" class="place-order-btn" id="submitBtn">
        COMPLETE ORDER
      </button>
      <p style="text-align:center; font-size:10px; margin-top:20px; opacity:0.6;">
        Secure Payment via ABA Pay / KHQR
      </p>
     </div>
    </aside>
   </main>
  </div>

  <div id="loadingModal" class="modal-overlay">
    <div class="modal-content">
        <h2 style="font-family:'Bebas Neue'; font-size:40px;">CONNECTING TO ABA...</h2>
        <p>Please do not close this window.</p>
    </div>
  </div>

  <script>
    const CartManager = {
        key: 'nexus_wear_cart',
        getCart() { return JSON.parse(localStorage.getItem(this.key)) || []; },
        clearCart() { localStorage.removeItem(this.key); }
    };

    function initCheckout() {
        const cart = CartManager.getCart();
        const summaryList = document.getElementById('summaryItemsList');
        const finalTotalEl = document.getElementById('finalTotal');

        if (cart.length === 0) {
            alert('Your cart is empty!');
            window.location.href = 'index.html';
            return;
        }

        let total = 0;
        summaryList.innerHTML = cart.map(item => {
            const itemTotal = item.price * item.qty;
            total += itemTotal;
            return `<div class="summary-item"><span>${item.name} (x${item.qty})</span><span>฿${itemTotal.toLocaleString()}</span></div>`;
        }).join('');

        finalTotalEl.innerText = `฿${total.toLocaleString()}`;

        const form = document.getElementById('checkoutForm');
        form.onsubmit = async (e) => {
            e.preventDefault();
            await processOrder(cart, total);
        };
    }

    async function processOrder(items, total) {
        const submitBtn = document.getElementById('submitBtn');
        const loadingModal = document.getElementById('loadingModal');
        
        submitBtn.disabled = true;
        loadingModal.style.display = 'flex';

        // สร้างข้อมูลส่งไป Backend
        const orderData = {
            order_id: "NXW-" + Date.now(), // ป้องกัน ID ซ้ำ
            customer: {
                email: document.getElementById('email').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                phone: document.getElementById('phone').value,
                address: `${document.getElementById('address').value}, ${document.getElementById('province').value}, ${document.getElementById('zip').value}`
            },
            items: items,
            total: total
        };

        try {
            // 1. เรียกไปที่ Render Backend ของคุณ
            const response = await fetch('https://aba-payway-backend.onrender.com/create-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(orderData)
            });
            
            const result = await response.json();

            if (result.success && result.aba_params) {
                // 2. ล้างตะกร้าเพราะเรากำลังจะย้ายไปหน้าชำระเงินแล้ว
                CartManager.clearCart();

                // 3. สร้าง Form จำลองเพื่อ POST ไปที่ ABA PayWay โดยตรง
                const abaForm = document.createElement('form');
                abaForm.method = 'POST';
                abaForm.action = result.aba_params.api_url; // URL ของ ABA Sandbox

                // ใส่ค่า Parameter ทั้งหมดที่ Backend เตรียมไว้ให้ (รวม Hash)
                for (const key in result.aba_params) {
                    if (key !== 'api_url') {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = result.aba_params[key];
                        abaForm.appendChild(input);
                    }
                }

                document.body.appendChild(abaForm);
                abaForm.submit(); // "ดีด" ผู้ใช้ไปหน้าชำระเงินของ ABA
            } else {
                throw new Error(result.error || "Backend Error");
            }

        } catch (error) {
            console.error(error);
            alert("ระบบขัดข้อง: " + error.message);
            submitBtn.disabled = false;
            loadingModal.style.display = 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', initCheckout);
  </script>
 </body>
</html>
