<!doctype html>
<html lang="th">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="pageTitle">Product Detail - Nexus Wear</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&amp;family=Bebas+Neue&amp;display=swap" rel="stylesheet">
  
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/data_utility.js"></script>
  <script src="/_sdk/analytics_sdk.js"></script>
  
  <style>
        /* (CSS Styles are kept the same for brevity - Your original styles here) */
        body {
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            background: #FFFFFF;
            color: #000000;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Layout */
        .page-wrapper {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .brand-logo a {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.5rem;
            text-decoration: none;
            color: #000000;
        }
        
        .cart-icon {
            position: relative;
            font-size: 1.5rem;
        }
        
        .cart-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: #E70000;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            text-align: center;
        }
        
        .product-container {
            display: flex;
            gap: 40px;
        }
        
        .product-gallery {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .main-image {
            width: 100%;
            height: auto;
            max-height: 600px;
            object-fit: cover;
            border: 1px solid #eee;
        }
        
        .thumbnails {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .thumbnails img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
            border: 1px solid transparent;
        }
        
        .thumbnails img:hover, .thumbnails img.active {
            opacity: 1;
            border-color: #000;
        }

        .product-details {
            flex: 1;
        }
        
        /* Details Styling */
        .product-details h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }
        
        .product-price {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 20px;
        }
        
        .option-group {
            margin-bottom: 20px;
        }
        
        .option-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .option-selection button, .option-selection select {
            padding: 10px 15px;
            margin-right: 10px;
            border: 1px solid #ccc;
            background-color: #fff;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
        }
        
        .option-selection button.selected, .option-selection select:focus {
            background-color: #000000;
            color: #FFFFFF;
            border-color: #000000;
        }
        
        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            vertical-align: middle;
        }
        
        .color-option.selected {
            border-color: #000000;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-control button {
            width: 35px;
            height: 35px;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            font-size: 1.2rem;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .quantity-input {
            width: 50px;
            text-align: center;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .add-to-cart-btn {
            flex: 1;
            padding: 15px 20px;
            background-color: #000000;
            color: #FFFFFF;
            border: none;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .buy-now-btn {
            flex: 1;
            padding: 15px 20px;
            background-color: #FFFFFF;
            color: #000000;
            border: 2px solid #000000;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s, color 0.2s;
        }
        
        .add-to-cart-btn:hover { background-color: #333333; }
        .buy-now-btn:hover { background-color: #f0f0f0; }

        /* Description/Accordion */
        .product-description-details {
            margin-top: 40px;
        }
        
        .detail-item {
            border-top: 1px solid #e0e0e0;
        }
        
        .detail-header {
            padding: 15px 0;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .detail-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding: 0 0;
        }
        
        .detail-item.active .detail-content {
            max-height: 500px; /* Adjust height based on expected content */
            padding: 10px 0 20px 0;
        }
        
        .detail-item.active .detail-header::after {
            content: '-';
        }
        
        .detail-header::after {
            content: '+';
            font-size: 1.5rem;
            line-height: 1;
        }
        
        /* Toast Notification (Basic Styling) */
        #toast {
            visibility: hidden; 
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 17px;
        }

        #toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        
        /* Simple Animations for Toast */
        @-webkit-keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        @keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
        @-webkit-keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
        @keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
        
        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .product-container {
                flex-direction: column;
                gap: 20px;
            }
            .product-gallery, .product-details {
                flex: none;
            }
            .main-image {
                max-height: 400px;
            }
            .action-buttons {
                flex-direction: column;
                gap: 10px;
            }
        }
  </style>
 </head>
 <body>

  <div id="toast"></div>

  <div class="page-wrapper">
    <header class="header-main">
      <div class="brand-logo"><a href="index.html" id="brandLogo">NEXUS WEAR</a></div>
      <div class="cart-icon">
        <a href="cart.html">üõí</a>
        <span class="cart-badge" id="cartCountBadge">0</span>
      </div>
    </header>

    <main class="product-container">
        
      <section class="product-gallery">
        <img id="mainProductImage" class="main-image" src="" alt="Main Product Image">
        <div class="thumbnails" id="productThumbnails">
          </div>
      </section>

      <section class="product-details">
        <p class="product-category" id="productCategory"></p>
        <h1 id="productName">Loading...</h1>
        <p class="product-price" id="productPrice">0.00 THB</p>

        <div class="option-group" id="sizeSelectionGroup" style="display: none;">
          <label>SIZE:</label>
          <div class="option-selection" id="sizeOptions">
            </div>
        </div>

        <div class="option-group" id="colorSelectionGroup" style="display: none;">
          <label>COLOR:</label>
          <div class="option-selection" id="colorOptions">
            </div>
        </div>

        <div class="option-group">
            <label>QUANTITY:</label>
            <div class="quantity-control">
                <button id="qtyDec">-</button>
                <input type="number" id="qtyInput" class="quantity-input" value="1" min="1">
                <button id="qtyInc">+</button>
            </div>
        </div>

        <div class="action-buttons">
          <button class="add-to-cart-btn" id="addToCartBtn">ADD TO CART</button>
          <button class="buy-now-btn" id="buyNowBtn">BUY NOW</button>
        </div>
        
        <div class="product-description-details">
            <div class="detail-item active">
                <div class="detail-header">DESCRIPTION</div>
                <div class="detail-content">
                    <p id="productDescription">Loading...</p>
                </div>
            </div>
            <div class="detail-item">
                <div class="detail-header">SHIPPING & RETURNS</div>
                <div class="detail-content">
                    <p>Free standard shipping on all orders over ‡∏ø2,000. Easy 30-day returns.</p>
                </div>
            </div>
        </div>
        
      </section>
    </main>
  </div>

  <script>
    // Utility functions
    const formatCurrency = (amount) => {
        return `${parseFloat(amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')} THB`;
    };

    function showToast(message, type = 'info') {
        const toast = document.getElementById('toast');
        if (!toast) return;
        toast.textContent = message;
        toast.className = 'show'; 
        setTimeout(function(){ 
            toast.className = toast.className.replace("show", ""); 
        }, 3000);
    }
    
    // Global State
    let currentProductData = null; 
    let selectedSize = null;
    let selectedColor = null;

    // ===========================================
    // CART BADGE & DATA SDK INTEGRATION
    // ===========================================
    
    /**
     * ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Badge ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
     * @param {number} count - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
     */
    function updateCartBadge(count) {
        const badge = document.getElementById('cartCountBadge');
        if (badge) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = count > 0 ? 'block' : 'none';
        }
    }

    /**
     * Initialise Data SDK ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Handler ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
     */
    async function initializeDataSdk() {
        if (window.dataSdk) {
            await window.dataSdk.init({
                onDataChanged: (cartData) => {
                    const count = cartData.reduce((total, item) => total + item.quantity, 0);
                    updateCartBadge(count);
                }
            });
            // Initial load of the cart count
            updateCartBadge(window.dataSdk.getCartCount()); 
        } else {
            console.error("Data SDK not found. Cart functionality disabled.");
        }
    }
    
    // ===========================================
    // PRODUCT DATA LOADING & RENDERING
    // ===========================================
    
    /**
     * ‡∏î‡∏∂‡∏á Product ID ‡∏à‡∏≤‡∏Å URL ‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
     */
    function getProductIdFromUrl() {
      // Mocking: In a real app, this would use URLSearchParams
      // For this mock, we use a fixed ID for the page
      return 'oversized-tee-black'; // Default Product ID for mock
    }

    function loadProductDataAndRender() {
        const productId = getProductIdFromUrl();
        if (!productId || !window.dataUtility) {
             document.getElementById('productName').textContent = 'Error: Data Utility or Product ID Missing';
             return;
        }
        
        const data = window.dataUtility.getProductById(productId);
        
        if (data) {
            currentProductData = data;
            renderProductDetails(data);
            renderThumbnails(data.gallery_images);
            renderOptions(data);
        } else {
            document.getElementById('productName').textContent = `Product ID "${productId}" not found.`;
        }
        
        // Initialize Accordion after content load
        initializeAccordion();
    }
    
    function renderProductDetails(data) {
        document.getElementById('productCategory').textContent = data.category;
        document.getElementById('productName').textContent = data.name;
        document.getElementById('productPrice').textContent = formatCurrency(data.price);
        document.getElementById('productDescription').textContent = data.description;
        document.getElementById('mainProductImage').src = data.image;
        document.getElementById('mainProductImage').alt = data.name;
    }

    function renderThumbnails(images) {
        const thumbContainer = document.getElementById('productThumbnails');
        thumbContainer.innerHTML = '';
        images.forEach((imgSrc, index) => {
            const img = document.createElement('img');
            img.src = imgSrc;
            img.alt = `Product view ${index + 1}`;
            img.className = 'product-thumbnail';
            if (index === 0) {
                img.classList.add('active'); // First image is active
            }
            thumbContainer.appendChild(img);
        });
        // Attach click listeners after rendering
        attachThumbnailListeners();
    }
    
    function renderOptions(data) {
        // --- Render Size Options ---
        const sizeOptionsEl = document.getElementById('sizeOptions');
        const sizeGroupEl = document.getElementById('sizeSelectionGroup');
        sizeOptionsEl.innerHTML = '';
        if (data.available_sizes && data.available_sizes.length > 0) {
            sizeGroupEl.style.display = 'block';
            data.available_sizes.forEach((size, index) => {
                const btn = document.createElement('button');
                btn.textContent = size;
                btn.setAttribute('data-option-type', 'size');
                btn.setAttribute('data-value', size);
                sizeOptionsEl.appendChild(btn);
                
                // Select the first size by default
                if (index === 0) {
                    btn.classList.add('selected');
                    selectedSize = size;
                }
            });
        } else {
             sizeGroupEl.style.display = 'none';
        }
        
        // --- Render Color Options ---
        const colorOptionsEl = document.getElementById('colorOptions');
        const colorGroupEl = document.getElementById('colorSelectionGroup');
        colorOptionsEl.innerHTML = '';
        if (data.available_colors && data.available_colors.length > 0) {
            colorGroupEl.style.display = 'block';
            data.available_colors.forEach((color, index) => {
                const span = document.createElement('span');
                span.className = 'color-option';
                span.style.backgroundColor = color.hex;
                span.title = color.name;
                span.setAttribute('data-option-type', 'color');
                span.setAttribute('data-value', color.name);
                colorOptionsEl.appendChild(span);
                
                // Select the first color by default
                if (index === 0) {
                    span.classList.add('selected');
                    selectedColor = color.name;
                }
            });
        } else {
            colorGroupEl.style.display = 'none';
        }
        
        // Attach click listeners after rendering
        attachOptionListeners();
    }
    
    // ===========================================
    // UI HANDLERS
    // ===========================================
    
    function handleOptionClick(e) {
        const btn = e.target;
        const type = btn.getAttribute('data-option-type');
        const value = btn.getAttribute('data-value');
        
        if (!type || !value) return;

        // Clear selection for the same group
        document.querySelectorAll(`[data-option-type="${type}"]`).forEach(el => {
            el.classList.remove('selected');
        });

        // Set new selection
        btn.classList.add('selected');

        if (type === 'size') {
            selectedSize = value;
        } else if (type === 'color') {
            selectedColor = value;
        }
    }
    
    function handleThumbnailClick(e) {
      const img = e.target;
      const mainImageEl = document.getElementById('mainProductImage');
      
      // Update main image source
      if (img && mainImageEl) {
        mainImageEl.src = img.src;
      }
      
      // Update active state
      document.querySelectorAll('.product-thumbnail').forEach(thumb => {
          thumb.classList.remove('active');
      });
      img.classList.add('active');
    }
    
    function initializeAccordion() {
        document.querySelectorAll('.detail-header').forEach(header => {
            header.addEventListener('click', () => {
                const item = header.closest('.detail-item');
                item.classList.toggle('active');
            });
        });
    }

    /**
     * ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
     * @returns {Promise<Object>} Result of the add operation
     */
    async function addToCart() {
        if (!window.dataSdk || !currentProductData) {
            return { isOk: false, error: 'System not ready.' };
        }
        
        const quantity = parseInt(document.getElementById('qtyInput').value || '1');
        
        // Validation
        if (quantity < 1) {
            showToast('Quantity must be at least 1.', 'error');
            return { isOk: false, error: 'Invalid quantity.' };
        }

        // Prepare item object for Data SDK
        const item = {
            id: currentProductData.id,
            name: currentProductData.name,
            price: currentProductData.price,
            image: currentProductData.image, // Use main image for cart list
            quantity: quantity,
            size: selectedSize,
            color: selectedColor,
            // Data SDK needs a backend ID logic, use utility function from data_sdk
            __backendId: window.dataSdk.genBackendId({ id: currentProductData.id, size: selectedSize, color: selectedColor }) 
        };
        
        const result = await window.dataSdk.add(item);
        
        if (result.isOk) {
            showToast('‚úÖ Added to cart!', 'success');
            
            // Analytics Tracking
            if (window.analyticsSdk) {
                window.analyticsSdk.trackEvent('AddToCart', {
                    product_id: item.id,
                    product_name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    size: item.size,
                    color: item.color
                });
            }
        } else {
             showToast(`Failed to add to cart: ${result.error}`, 'error');
        }
        return result;
    }
    
    // ===========================================
    // WIRE UP LISTENERS
    // ===========================================

    function attachThumbnailListeners() {
        document.querySelectorAll('.product-thumbnail').forEach(img => {
            img.removeEventListener('click', handleThumbnailClick);
            img.addEventListener('click', handleThumbnailClick);
        });
    }

    function attachOptionListeners() {
        document.querySelectorAll('[data-option-type]').forEach(el => {
            el.removeEventListener('click', handleOptionClick);
            el.addEventListener('click', handleOptionClick);
        });
    }

    function wireUpButtons() {
        // Quantity Controls
        document.getElementById('qtyInc').addEventListener('click', () => {
            const input = document.getElementById('qtyInput');
            input.value = parseInt(input.value) + 1;
        });
        document.getElementById('qtyDec').addEventListener('click', () => {
            const input = document.getElementById('qtyInput');
            const newValue = parseInt(input.value) - 1;
            input.value = newValue > 0 ? newValue : 1;
        });

        // Add to Cart / Buy Now
        const addBtn = document.getElementById('addToCartBtn');
        if (addBtn) addBtn.addEventListener('click', addToCart);
      
        const buyNowBtn = document.getElementById('buyNowBtn');
        if (buyNowBtn) buyNowBtn.addEventListener('click', () => {
          // Buy Now: Add to cart then redirect to cart page
          addToCart().then((result) => {
             if (result && result.isOk) {
               window.location.href = 'cart.html';
             }
          });
        });
    }
    
    // ===========================================
    // ELEMENT SDK CONFIG
    // ===========================================

    const defaultConfig = { 
        page_title: 'PRODUCT DETAIL', 
        brand_name: 'NEXUS WEAR', 
    };

    function handleConfigChange(config) {
        document.getElementById('pageTitle').textContent = config.page_title || defaultConfig.page_title;
        document.getElementById('brandLogo').textContent = config.brand_name || defaultConfig.brand_name;
    }


    // ===========================================
    // INITIALIZATION
    // ===========================================

    document.addEventListener('DOMContentLoaded', async () => {
      // 1. Initialize SDKs
      await initializeDataSdk(); // Must be first to update cart badge
      
      if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig: defaultConfig,
                onConfigChange: handleConfigChange
            });
      }
      if (window.analyticsSdk) {
            window.analyticsSdk.init();
            window.analyticsSdk.trackPageView('Product Detail Page');
      }

      // 2. Load Data and Render UI
      loadProductDataAndRender();
      
      // 3. Wire up Event Listeners
      wireUpButtons();
    });

  </script>
 </body>
</html>
